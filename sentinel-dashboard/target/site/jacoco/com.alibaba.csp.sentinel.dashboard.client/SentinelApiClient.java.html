<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SentinelApiClient.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">sentinel-dashboard</a> &gt; <a href="index.source.html" class="el_package">com.alibaba.csp.sentinel.dashboard.client</a> &gt; <span class="el_source">SentinelApiClient.java</span></div><h1>SentinelApiClient.java</h1><pre class="source lang-java linenums">/*
 * Copyright 1999-2018 Alibaba Group Holding Ltd.
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package com.alibaba.csp.sentinel.dashboard.client;

import java.io.UnsupportedEncodingException;
import java.net.URLEncoder;
import java.nio.charset.Charset;
import java.util.ArrayList;
import java.util.Collections;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.Map.Entry;
import java.util.Optional;
import java.util.Set;
import java.util.concurrent.CompletableFuture;
import java.util.concurrent.ExecutionException;
import java.util.stream.Collectors;

import com.alibaba.csp.sentinel.adapter.gateway.common.rule.GatewayFlowRule;
import com.alibaba.csp.sentinel.command.CommandConstants;
import com.alibaba.csp.sentinel.config.SentinelConfig;
import com.alibaba.csp.sentinel.command.vo.NodeVo;
import com.alibaba.csp.sentinel.dashboard.datasource.entity.gateway.ApiDefinitionEntity;
import com.alibaba.csp.sentinel.dashboard.datasource.entity.gateway.GatewayFlowRuleEntity;
import com.alibaba.csp.sentinel.dashboard.util.AsyncUtils;
import com.alibaba.csp.sentinel.slots.block.Rule;
import com.alibaba.csp.sentinel.slots.block.authority.AuthorityRule;
import com.alibaba.csp.sentinel.slots.block.degrade.DegradeRule;
import com.alibaba.csp.sentinel.slots.block.flow.FlowRule;
import com.alibaba.csp.sentinel.slots.block.flow.param.ParamFlowRule;
import com.alibaba.csp.sentinel.slots.system.SystemRule;
import com.alibaba.csp.sentinel.util.AssertUtil;
import com.alibaba.csp.sentinel.util.StringUtil;
import com.alibaba.fastjson.JSON;
import com.alibaba.csp.sentinel.dashboard.datasource.entity.SentinelVersion;
import com.alibaba.csp.sentinel.dashboard.datasource.entity.rule.AuthorityRuleEntity;
import com.alibaba.csp.sentinel.dashboard.datasource.entity.rule.DegradeRuleEntity;
import com.alibaba.csp.sentinel.dashboard.datasource.entity.rule.FlowRuleEntity;
import com.alibaba.csp.sentinel.dashboard.datasource.entity.rule.ParamFlowRuleEntity;
import com.alibaba.csp.sentinel.dashboard.datasource.entity.rule.RuleEntity;
import com.alibaba.csp.sentinel.dashboard.datasource.entity.rule.SystemRuleEntity;
import com.alibaba.csp.sentinel.dashboard.discovery.AppManagement;
import com.alibaba.csp.sentinel.dashboard.domain.cluster.ClusterClientInfoVO;
import com.alibaba.csp.sentinel.dashboard.domain.cluster.state.ClusterServerStateVO;
import com.alibaba.csp.sentinel.dashboard.domain.cluster.state.ClusterStateSimpleEntity;
import com.alibaba.csp.sentinel.dashboard.domain.cluster.config.ClusterClientConfig;
import com.alibaba.csp.sentinel.dashboard.domain.cluster.config.ServerFlowConfig;
import com.alibaba.csp.sentinel.dashboard.domain.cluster.config.ServerTransportConfig;
import com.alibaba.csp.sentinel.dashboard.util.VersionUtils;

import org.apache.http.HttpResponse;
import org.apache.http.NameValuePair;
import org.apache.http.client.entity.UrlEncodedFormEntity;
import org.apache.http.client.methods.HttpGet;
import org.apache.http.client.methods.HttpPost;
import org.apache.http.client.methods.HttpUriRequest;
import org.apache.http.concurrent.FutureCallback;
import org.apache.http.entity.ContentType;
import org.apache.http.impl.client.DefaultRedirectStrategy;
import org.apache.http.impl.nio.client.CloseableHttpAsyncClient;
import org.apache.http.impl.nio.client.HttpAsyncClients;
import org.apache.http.impl.nio.reactor.IOReactorConfig;
import org.apache.http.message.BasicNameValuePair;
import org.apache.http.util.EntityUtils;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.lang.Nullable;
import org.springframework.stereotype.Component;

/**
 * Communicate with Sentinel client.
 *
 * @author leyou
 */
@Component
public class SentinelApiClient {
<span class="fc" id="L92">    private static Logger logger = LoggerFactory.getLogger(SentinelApiClient.class);</span>

<span class="fc" id="L94">    private static final Charset DEFAULT_CHARSET = Charset.forName(SentinelConfig.charset());</span>

    private static final String RESOURCE_URL_PATH = &quot;jsonTree&quot;;
    private static final String CLUSTER_NODE_PATH = &quot;clusterNode&quot;;
    private static final String GET_RULES_PATH = &quot;getRules&quot;;
    private static final String SET_RULES_PATH = &quot;setRules&quot;;
    private static final String GET_PARAM_RULE_PATH = &quot;getParamFlowRules&quot;;
    private static final String SET_PARAM_RULE_PATH = &quot;setParamFlowRules&quot;;

    private static final String FETCH_CLUSTER_MODE_PATH = &quot;getClusterMode&quot;;
    private static final String MODIFY_CLUSTER_MODE_PATH = &quot;setClusterMode&quot;;
    private static final String FETCH_CLUSTER_CLIENT_CONFIG_PATH = &quot;cluster/client/fetchConfig&quot;;
    private static final String MODIFY_CLUSTER_CLIENT_CONFIG_PATH = &quot;cluster/client/modifyConfig&quot;;

    private static final String FETCH_CLUSTER_SERVER_ALL_CONFIG_PATH = &quot;cluster/server/fetchConfig&quot;;
    private static final String FETCH_CLUSTER_SERVER_BASIC_INFO_PATH = &quot;cluster/server/info&quot;;

    private static final String MODIFY_CLUSTER_SERVER_TRANSPORT_CONFIG_PATH = &quot;cluster/server/modifyTransportConfig&quot;;
    private static final String MODIFY_CLUSTER_SERVER_FLOW_CONFIG_PATH = &quot;cluster/server/modifyFlowConfig&quot;;
    private static final String MODIFY_CLUSTER_SERVER_NAMESPACE_SET_PATH = &quot;cluster/server/modifyNamespaceSet&quot;;

    private static final String FETCH_GATEWAY_API_PATH = &quot;gateway/getApiDefinitions&quot;;
    private static final String MODIFY_GATEWAY_API_PATH = &quot;gateway/updateApiDefinitions&quot;;

    private static final String FETCH_GATEWAY_FLOW_RULE_PATH = &quot;gateway/getRules&quot;;
    private static final String MODIFY_GATEWAY_FLOW_RULE_PATH = &quot;gateway/updateRules&quot;;

    private static final String FLOW_RULE_TYPE = &quot;flow&quot;;
    private static final String DEGRADE_RULE_TYPE = &quot;degrade&quot;;
    private static final String SYSTEM_RULE_TYPE = &quot;system&quot;;
    private static final String AUTHORITY_TYPE = &quot;authority&quot;;

    private CloseableHttpAsyncClient httpClient;

<span class="fc" id="L128">    private static final SentinelVersion version160 = new SentinelVersion(1, 6, 0);</span>
    
    @Autowired
    private AppManagement appManagement;

<span class="nc" id="L133">    public SentinelApiClient() {</span>
<span class="nc" id="L134">        IOReactorConfig ioConfig = IOReactorConfig.custom().setConnectTimeout(3000).setSoTimeout(10000)</span>
<span class="nc" id="L135">            .setIoThreadCount(Runtime.getRuntime().availableProcessors() * 2).build();</span>
<span class="nc" id="L136">        httpClient = HttpAsyncClients.custom().setRedirectStrategy(new DefaultRedirectStrategy() {</span>
            @Override
            protected boolean isRedirectable(final String method) {
<span class="nc" id="L139">                return false;</span>
            }
<span class="nc" id="L141">        }).setMaxConnTotal(4000).setMaxConnPerRoute(1000).setDefaultIOReactorConfig(ioConfig).build();</span>
<span class="nc" id="L142">        httpClient.start();</span>
<span class="nc" id="L143">    }</span>

    private boolean isSuccess(int statusCode) {
<span class="nc bnc" id="L146" title="All 4 branches missed.">        return statusCode &gt;= 200 &amp;&amp; statusCode &lt; 300;</span>
    }
    
    private boolean isCommandNotFound(int statusCode, String body) {
<span class="nc bnc" id="L150" title="All 6 branches missed.">        return statusCode == 400 &amp;&amp; StringUtil.isNotEmpty(body) &amp;&amp; body.contains(CommandConstants.MSG_UNKNOWN_COMMAND_PREFIX);</span>
    }
    
    private StringBuilder queryString(Map&lt;String, String&gt; params) {
<span class="nc" id="L154">        StringBuilder queryStringBuilder = new StringBuilder();</span>
<span class="nc bnc" id="L155" title="All 2 branches missed.">        for (Entry&lt;String, String&gt; entry : params.entrySet()) {</span>
<span class="nc bnc" id="L156" title="All 2 branches missed.">            if (StringUtil.isEmpty(entry.getValue())) {</span>
<span class="nc" id="L157">                continue;</span>
            }
<span class="nc" id="L159">            String name = urlEncode(entry.getKey());</span>
<span class="nc" id="L160">            String value = urlEncode(entry.getValue());</span>
<span class="nc bnc" id="L161" title="All 4 branches missed.">            if (name != null &amp;&amp; value != null) {</span>
<span class="nc bnc" id="L162" title="All 2 branches missed.">                if (queryStringBuilder.length() &gt; 0) {</span>
<span class="nc" id="L163">                    queryStringBuilder.append('&amp;');</span>
                }
<span class="nc" id="L165">                queryStringBuilder.append(name).append('=').append(value);</span>
            }
<span class="nc" id="L167">        }</span>
<span class="nc" id="L168">        return queryStringBuilder;</span>
    }
    
    private HttpUriRequest postRequest(String url, Map&lt;String, String&gt; params) {
<span class="nc" id="L172">        HttpPost httpPost = new HttpPost(url);</span>
<span class="nc bnc" id="L173" title="All 4 branches missed.">        if (params != null &amp;&amp; params.size() &gt; 0) {</span>
<span class="nc" id="L174">            List&lt;NameValuePair&gt; list = new ArrayList&lt;&gt;(params.size());</span>
<span class="nc bnc" id="L175" title="All 2 branches missed.">            for (Entry&lt;String, String&gt; entry : params.entrySet()) {</span>
<span class="nc" id="L176">                list.add(new BasicNameValuePair(entry.getKey(), entry.getValue()));</span>
<span class="nc" id="L177">            }</span>
            try {
<span class="nc" id="L179">                httpPost.setEntity(new UrlEncodedFormEntity(list));</span>
<span class="nc" id="L180">            } catch (UnsupportedEncodingException e) {</span>
<span class="nc" id="L181">                logger.warn(&quot;httpPostContent encode entity error: {}&quot;, params, e);</span>
<span class="nc" id="L182">                return null;</span>
<span class="nc" id="L183">            }</span>
        }
<span class="nc" id="L185">        return httpPost;</span>
    }
    
    private String urlEncode(String str) {
        try {
<span class="nc" id="L190">            return URLEncoder.encode(str, DEFAULT_CHARSET.name());</span>
<span class="nc" id="L191">        } catch (UnsupportedEncodingException e) {</span>
<span class="nc" id="L192">            logger.info(&quot;encode string error: {}&quot;, str, e);</span>
<span class="nc" id="L193">            return null;</span>
        }
    }
    
    private String getBody(HttpResponse response) throws Exception {
<span class="nc" id="L198">        Charset charset = null;</span>
        try {
<span class="nc" id="L200">            String contentTypeStr = response.getFirstHeader(&quot;Content-type&quot;).getValue();</span>
<span class="nc bnc" id="L201" title="All 2 branches missed.">            if (StringUtil.isNotEmpty(contentTypeStr)) {</span>
<span class="nc" id="L202">                ContentType contentType = ContentType.parse(contentTypeStr);</span>
<span class="nc" id="L203">                charset = contentType.getCharset();</span>
            }
<span class="nc" id="L205">        } catch (Exception ignore) {</span>
<span class="nc" id="L206">        }</span>
<span class="nc bnc" id="L207" title="All 2 branches missed.">        return EntityUtils.toString(response.getEntity(), charset != null ? charset : DEFAULT_CHARSET);</span>
    }
    
    /**
     * With no param
     * 
     * @param ip
     * @param port
     * @param api
     * @return
     */
    private CompletableFuture&lt;String&gt; executeCommand(String ip, int port, String api, boolean useHttpPost) {
<span class="nc" id="L219">        return executeCommand(ip, port, api, null, useHttpPost);</span>
    }
    
    /**
     * No app specified, force to GET
     * 
     * @param ip
     * @param port
     * @param api
     * @param params
     * @return
     */
    private CompletableFuture&lt;String&gt; executeCommand(String ip, int port, String api, Map&lt;String, String&gt; params, boolean useHttpPost) {
<span class="nc" id="L232">        return executeCommand(null, ip, port, api, params, useHttpPost);</span>
    }

    /**
     * Prefer to execute request using POST
     * 
     * @param app
     * @param ip
     * @param port
     * @param api
     * @param params
     * @return
     */
    private CompletableFuture&lt;String&gt; executeCommand(String app, String ip, int port, String api, Map&lt;String, String&gt; params, boolean useHttpPost) {
<span class="nc" id="L246">        CompletableFuture&lt;String&gt; future = new CompletableFuture&lt;&gt;();</span>
<span class="nc bnc" id="L247" title="All 4 branches missed.">        if (StringUtil.isBlank(ip) || StringUtil.isBlank(api)) {</span>
<span class="nc" id="L248">            future.completeExceptionally(new IllegalArgumentException(&quot;Bad URL or command name&quot;));</span>
<span class="nc" id="L249">            return future;</span>
        }
<span class="nc" id="L251">        StringBuilder urlBuilder = new StringBuilder();</span>
<span class="nc" id="L252">        urlBuilder.append(&quot;http://&quot;);</span>
<span class="nc" id="L253">        urlBuilder.append(ip).append(':').append(port).append('/').append(api);</span>
<span class="nc bnc" id="L254" title="All 2 branches missed.">        if (params == null) {</span>
<span class="nc" id="L255">            params = Collections.emptyMap();</span>
        }
<span class="nc bnc" id="L257" title="All 2 branches missed.">        boolean supportPost = StringUtil.isNotEmpty(app) &amp;&amp; Optional.ofNullable(appManagement.getDetailApp(app))</span>
<span class="nc" id="L258">                .flatMap(e -&gt; e.getMachine(ip, port))</span>
<span class="nc" id="L259">                .flatMap(m -&gt; VersionUtils.parseVersion(m.getVersion())</span>
<span class="nc" id="L260">                    .map(v -&gt; v.greaterOrEqual(version160)))</span>
<span class="nc bnc" id="L261" title="All 2 branches missed.">                .orElse(false);</span>
<span class="nc bnc" id="L262" title="All 4 branches missed.">        if (!useHttpPost || !supportPost) {</span>
            // Using GET in older versions, append parameters after url
<span class="nc bnc" id="L264" title="All 2 branches missed.">            if (!params.isEmpty()) {</span>
<span class="nc bnc" id="L265" title="All 2 branches missed.">                if (urlBuilder.indexOf(&quot;?&quot;) == -1) {</span>
<span class="nc" id="L266">                    urlBuilder.append('?');</span>
                } else {
<span class="nc" id="L268">                    urlBuilder.append('&amp;');</span>
                }
<span class="nc" id="L270">                urlBuilder.append(queryString(params));</span>
            }
<span class="nc" id="L272">            return executeCommand(new HttpGet(urlBuilder.toString()));</span>
        } else {
            // Using POST
<span class="nc" id="L275">            return executeCommand(postRequest(urlBuilder.toString(), params));</span>
        }
    }
    
    private CompletableFuture&lt;String&gt; executeCommand(HttpUriRequest request) {
<span class="nc" id="L280">        CompletableFuture&lt;String&gt; future = new CompletableFuture&lt;&gt;();</span>
<span class="nc" id="L281">        httpClient.execute(request, new FutureCallback&lt;HttpResponse&gt;() {</span>
            @Override
            public void completed(final HttpResponse response) {
<span class="nc" id="L284">                int statusCode = response.getStatusLine().getStatusCode();</span>
                try {
<span class="nc" id="L286">                    String value = getBody(response);</span>
<span class="nc bnc" id="L287" title="All 2 branches missed.">                    if (isSuccess(statusCode)) {</span>
<span class="nc" id="L288">                        future.complete(value);</span>
                    } else {
<span class="nc bnc" id="L290" title="All 2 branches missed.">                        if (isCommandNotFound(statusCode, value)) {</span>
<span class="nc" id="L291">                            future.completeExceptionally(new CommandNotFoundException(request.getURI().getPath()));</span>
                        } else {
<span class="nc" id="L293">                            future.completeExceptionally(new CommandFailedException(value));</span>
                        }
                    }

<span class="nc" id="L297">                } catch (Exception ex) {</span>
<span class="nc" id="L298">                    future.completeExceptionally(ex);</span>
<span class="nc" id="L299">                    logger.error(&quot;HTTP request failed: {}&quot;, request.getURI().toString(), ex);</span>
<span class="nc" id="L300">                }</span>
<span class="nc" id="L301">            }</span>

            @Override
            public void failed(final Exception ex) {
<span class="nc" id="L305">                future.completeExceptionally(ex);</span>
<span class="nc" id="L306">                logger.error(&quot;HTTP request failed: {}&quot;, request.getURI().toString(), ex);</span>
<span class="nc" id="L307">            }</span>

            @Override
            public void cancelled() {
<span class="nc" id="L311">                future.complete(null);</span>
<span class="nc" id="L312">            }</span>
        });
<span class="nc" id="L314">        return future;</span>
    }
    
    public void close() throws Exception {
<span class="nc" id="L318">        httpClient.close();</span>
<span class="nc" id="L319">    }</span>
    
    @Nullable
    private &lt;T&gt; CompletableFuture&lt;List&lt;T&gt;&gt; fetchItemsAsync(String ip, int port, String api, String type, Class&lt;T&gt; ruleType) {
<span class="nc" id="L323">        AssertUtil.notEmpty(ip, &quot;Bad machine IP&quot;);</span>
<span class="nc bnc" id="L324" title="All 2 branches missed.">        AssertUtil.isTrue(port &gt; 0, &quot;Bad machine port&quot;);</span>
<span class="nc" id="L325">        Map&lt;String, String&gt; params = null;</span>
<span class="nc bnc" id="L326" title="All 2 branches missed.">        if (StringUtil.isNotEmpty(type)) {</span>
<span class="nc" id="L327">            params = new HashMap&lt;&gt;(1);</span>
<span class="nc" id="L328">            params.put(&quot;type&quot;, type);</span>
        }
<span class="nc" id="L330">        return executeCommand(ip, port, api, params, false)</span>
<span class="nc" id="L331">                .thenApply(json -&gt; JSON.parseArray(json, ruleType));</span>
    }
    
    @Nullable
    private &lt;T&gt; List&lt;T&gt; fetchItems(String ip, int port, String api, String type, Class&lt;T&gt; ruleType) {
        try {
<span class="nc" id="L337">            AssertUtil.notEmpty(ip, &quot;Bad machine IP&quot;);</span>
<span class="nc bnc" id="L338" title="All 2 branches missed.">            AssertUtil.isTrue(port &gt; 0, &quot;Bad machine port&quot;);</span>
<span class="nc" id="L339">            Map&lt;String, String&gt; params = null;</span>
<span class="nc bnc" id="L340" title="All 2 branches missed.">            if (StringUtil.isNotEmpty(type)) {</span>
<span class="nc" id="L341">                params = new HashMap&lt;&gt;(1);</span>
<span class="nc" id="L342">                params.put(&quot;type&quot;, type);</span>
            }
<span class="nc" id="L344">            return fetchItemsAsync(ip, port, api, type, ruleType).get();</span>
<span class="nc" id="L345">        } catch (InterruptedException | ExecutionException e) {</span>
<span class="nc" id="L346">            logger.error(&quot;Error when fetching items from api: {} -&gt; {}&quot;, api, type, e);</span>
<span class="nc" id="L347">            return null;</span>
<span class="nc" id="L348">        } catch (Exception e) {</span>
<span class="nc" id="L349">            logger.error(&quot;Error when fetching items: {} -&gt; {}&quot;, api, type, e);</span>
<span class="nc" id="L350">            return null;</span>
        }
    }
    
    private &lt;T extends Rule&gt; List&lt;T&gt; fetchRules(String ip, int port, String type, Class&lt;T&gt; ruleType) {
<span class="nc" id="L355">        return fetchItems(ip, port, GET_RULES_PATH, type, ruleType);</span>
    }
    
    private boolean setRules(String app, String ip, int port, String type, List&lt;? extends RuleEntity&gt; entities) {
<span class="nc bnc" id="L359" title="All 2 branches missed.">        if (entities == null) {</span>
<span class="nc" id="L360">            return true;</span>
        }
        try {
<span class="nc" id="L363">            AssertUtil.notEmpty(app, &quot;Bad app name&quot;);</span>
<span class="nc" id="L364">            AssertUtil.notEmpty(ip, &quot;Bad machine IP&quot;);</span>
<span class="nc bnc" id="L365" title="All 2 branches missed.">            AssertUtil.isTrue(port &gt; 0, &quot;Bad machine port&quot;);</span>
<span class="nc" id="L366">            String data = JSON.toJSONString(</span>
<span class="nc" id="L367">                    entities.stream().map(r -&gt; r.toRule()).collect(Collectors.toList()));</span>
<span class="nc" id="L368">            Map&lt;String, String&gt; params = new HashMap&lt;&gt;(2);</span>
<span class="nc" id="L369">            params.put(&quot;type&quot;, type);</span>
<span class="nc" id="L370">            params.put(&quot;data&quot;, data);</span>
<span class="nc" id="L371">            String result = executeCommand(app, ip, port, SET_RULES_PATH, params, true).get();</span>
<span class="nc" id="L372">            logger.info(&quot;setRules: {}&quot;, result);</span>
<span class="nc" id="L373">            return true;</span>
<span class="nc" id="L374">        } catch (InterruptedException | ExecutionException e) {</span>
<span class="nc" id="L375">            logger.warn(&quot;setRules api failed: {}&quot;, type, e);</span>
<span class="nc" id="L376">            return false;</span>
<span class="nc" id="L377">        } catch (Exception e) {</span>
<span class="nc" id="L378">            logger.warn(&quot;setRules failed&quot;, e);</span>
<span class="nc" id="L379">            return false;</span>
        }
    }

    public List&lt;NodeVo&gt; fetchResourceOfMachine(String ip, int port, String type) {
<span class="nc" id="L384">        return fetchItems(ip, port, RESOURCE_URL_PATH, type, NodeVo.class);</span>
    }

    /**
     * Fetch cluster node.
     *
     * @param ip          ip to fetch
     * @param port        port of the ip
     * @param includeZero whether zero value should in the result list.
     * @return
     */
    public List&lt;NodeVo&gt; fetchClusterNodeOfMachine(String ip, int port, boolean includeZero) {
<span class="nc" id="L396">        String type = &quot;noZero&quot;;</span>
<span class="nc bnc" id="L397" title="All 2 branches missed.">        if (includeZero) {</span>
<span class="nc" id="L398">            type = &quot;zero&quot;;</span>
        }
<span class="nc" id="L400">        return fetchItems(ip, port, CLUSTER_NODE_PATH, type, NodeVo.class);</span>
    }

    public List&lt;FlowRuleEntity&gt; fetchFlowRuleOfMachine(String app, String ip, int port) {
<span class="nc" id="L404">        List&lt;FlowRule&gt; rules = fetchRules(ip, port, FLOW_RULE_TYPE, FlowRule.class);</span>
<span class="nc bnc" id="L405" title="All 2 branches missed.">        if (rules != null) {</span>
<span class="nc" id="L406">            return rules.stream().map(rule -&gt; FlowRuleEntity.fromFlowRule(app, ip, port, rule))</span>
<span class="nc" id="L407">                .collect(Collectors.toList());</span>
        } else {
<span class="nc" id="L409">            return null;</span>
        }
    }

    public List&lt;DegradeRuleEntity&gt; fetchDegradeRuleOfMachine(String app, String ip, int port) {
<span class="nc" id="L414">        List&lt;DegradeRule&gt; rules = fetchRules(ip, port, DEGRADE_RULE_TYPE, DegradeRule.class);</span>
<span class="nc bnc" id="L415" title="All 2 branches missed.">        if (rules != null) {</span>
<span class="nc" id="L416">            return rules.stream().map(rule -&gt; DegradeRuleEntity.fromDegradeRule(app, ip, port, rule))</span>
<span class="nc" id="L417">                .collect(Collectors.toList());</span>
        } else {
<span class="nc" id="L419">            return null;</span>
        }
    }

    public List&lt;SystemRuleEntity&gt; fetchSystemRuleOfMachine(String app, String ip, int port) {
<span class="nc" id="L424">        List&lt;SystemRule&gt; rules = fetchRules(ip, port, SYSTEM_RULE_TYPE, SystemRule.class);</span>
<span class="nc bnc" id="L425" title="All 2 branches missed.">        if (rules != null) {</span>
<span class="nc" id="L426">            return rules.stream().map(rule -&gt; SystemRuleEntity.fromSystemRule(app, ip, port, rule))</span>
<span class="nc" id="L427">                .collect(Collectors.toList());</span>
        } else {
<span class="nc" id="L429">            return null;</span>
        }
    }

    /**
     * Fetch all parameter flow rules from provided machine.
     *
     * @param app  application name
     * @param ip   machine client IP
     * @param port machine client port
     * @return all retrieved parameter flow rules
     * @since 0.2.1
     */
    public CompletableFuture&lt;List&lt;ParamFlowRuleEntity&gt;&gt; fetchParamFlowRulesOfMachine(String app, String ip, int port) {
        try {
<span class="nc" id="L444">            AssertUtil.notEmpty(app, &quot;Bad app name&quot;);</span>
<span class="nc" id="L445">            AssertUtil.notEmpty(ip, &quot;Bad machine IP&quot;);</span>
<span class="nc bnc" id="L446" title="All 2 branches missed.">            AssertUtil.isTrue(port &gt; 0, &quot;Bad machine port&quot;);</span>
<span class="nc" id="L447">            return fetchItemsAsync(ip, port, GET_PARAM_RULE_PATH, null, ParamFlowRule.class)</span>
<span class="nc" id="L448">                .thenApply(rules -&gt; rules.stream()</span>
<span class="nc" id="L449">                    .map(e -&gt; ParamFlowRuleEntity.fromAuthorityRule(app, ip, port, e))</span>
<span class="nc" id="L450">                    .collect(Collectors.toList())</span>
                );
<span class="nc" id="L452">        } catch (Exception e) {</span>
<span class="nc" id="L453">            logger.error(&quot;Error when fetching parameter flow rules&quot;, e);</span>
<span class="nc" id="L454">            return AsyncUtils.newFailedFuture(e);</span>
        }
    }

    /**
     * Fetch all authority rules from provided machine.
     *
     * @param app  application name
     * @param ip   machine client IP
     * @param port machine client port
     * @return all retrieved authority rules
     * @since 0.2.1
     */
    public List&lt;AuthorityRuleEntity&gt; fetchAuthorityRulesOfMachine(String app, String ip, int port) {
<span class="nc" id="L468">        AssertUtil.notEmpty(app, &quot;Bad app name&quot;);</span>
<span class="nc" id="L469">        AssertUtil.notEmpty(ip, &quot;Bad machine IP&quot;);</span>
<span class="nc bnc" id="L470" title="All 2 branches missed.">        AssertUtil.isTrue(port &gt; 0, &quot;Bad machine port&quot;);</span>
<span class="nc" id="L471">        Map&lt;String, String&gt; params = new HashMap&lt;&gt;(1);</span>
<span class="nc" id="L472">        params.put(&quot;type&quot;, AUTHORITY_TYPE);</span>
<span class="nc" id="L473">        List&lt;AuthorityRule&gt; rules = fetchRules(ip, port, AUTHORITY_TYPE, AuthorityRule.class);</span>
<span class="nc" id="L474">        return Optional.ofNullable(rules).map(r -&gt; r.stream()</span>
<span class="nc" id="L475">                    .map(e -&gt; AuthorityRuleEntity.fromAuthorityRule(app, ip, port, e))</span>
<span class="nc" id="L476">                    .collect(Collectors.toList())</span>
<span class="nc" id="L477">                ).orElse(null);</span>
    }

    /**
     * set rules of the machine. rules == null will return immediately;
     * rules.isEmpty() means setting the rules to empty.
     *
     * @param app
     * @param ip
     * @param port
     * @param rules
     * @return whether successfully set the rules.
     */
    public boolean setFlowRuleOfMachine(String app, String ip, int port, List&lt;FlowRuleEntity&gt; rules) {
<span class="nc" id="L491">        return setRules(app, ip, port, FLOW_RULE_TYPE, rules);</span>
    }

    /**
     * set rules of the machine. rules == null will return immediately;
     * rules.isEmpty() means setting the rules to empty.
     *
     * @param app
     * @param ip
     * @param port
     * @param rules
     * @return whether successfully set the rules.
     */
    public boolean setDegradeRuleOfMachine(String app, String ip, int port, List&lt;DegradeRuleEntity&gt; rules) {
<span class="nc" id="L505">        return setRules(app, ip, port, DEGRADE_RULE_TYPE, rules);</span>
    }

    /**
     * set rules of the machine. rules == null will return immediately;
     * rules.isEmpty() means setting the rules to empty.
     *
     * @param app
     * @param ip
     * @param port
     * @param rules
     * @return whether successfully set the rules.
     */
    public boolean setSystemRuleOfMachine(String app, String ip, int port, List&lt;SystemRuleEntity&gt; rules) {
<span class="nc" id="L519">        return setRules(app, ip, port, SYSTEM_RULE_TYPE, rules);</span>
    }

    public boolean setAuthorityRuleOfMachine(String app, String ip, int port, List&lt;AuthorityRuleEntity&gt; rules) {
<span class="nc" id="L523">        return setRules(app, ip, port, AUTHORITY_TYPE, rules);</span>
    }

    public CompletableFuture&lt;Void&gt; setParamFlowRuleOfMachine(String app, String ip, int port, List&lt;ParamFlowRuleEntity&gt; rules) {
<span class="nc bnc" id="L527" title="All 2 branches missed.">        if (rules == null) {</span>
<span class="nc" id="L528">            return CompletableFuture.completedFuture(null);</span>
        }
<span class="nc bnc" id="L530" title="All 4 branches missed.">        if (StringUtil.isBlank(ip) || port &lt;= 0) {</span>
<span class="nc" id="L531">            return AsyncUtils.newFailedFuture(new IllegalArgumentException(&quot;Invalid parameter&quot;));</span>
        }
        try {
<span class="nc" id="L534">            String data = JSON.toJSONString(</span>
<span class="nc" id="L535">                rules.stream().map(ParamFlowRuleEntity::getRule).collect(Collectors.toList())</span>
            );
<span class="nc" id="L537">            Map&lt;String, String&gt; params = new HashMap&lt;&gt;(1);</span>
<span class="nc" id="L538">            params.put(&quot;data&quot;, data);</span>
<span class="nc" id="L539">            return executeCommand(app, ip, port, SET_PARAM_RULE_PATH, params, true)</span>
<span class="nc" id="L540">                .thenCompose(e -&gt; {</span>
<span class="nc bnc" id="L541" title="All 2 branches missed.">                    if (CommandConstants.MSG_SUCCESS.equals(e)) {</span>
<span class="nc" id="L542">                        return CompletableFuture.completedFuture(null);</span>
                    } else {
<span class="nc" id="L544">                        logger.warn(&quot;Push parameter flow rules to client failed: &quot; + e);</span>
<span class="nc" id="L545">                        return AsyncUtils.newFailedFuture(new RuntimeException(e));</span>
                    }
                });
<span class="nc" id="L548">        } catch (Exception ex) {</span>
<span class="nc" id="L549">            logger.warn(&quot;Error when setting parameter flow rule&quot;, ex);</span>
<span class="nc" id="L550">            return AsyncUtils.newFailedFuture(ex);</span>
        }
    }

    // Cluster related

    public CompletableFuture&lt;ClusterStateSimpleEntity&gt; fetchClusterMode(String ip, int port) {
<span class="nc bnc" id="L557" title="All 4 branches missed.">        if (StringUtil.isBlank(ip) || port &lt;= 0) {</span>
<span class="nc" id="L558">            return AsyncUtils.newFailedFuture(new IllegalArgumentException(&quot;Invalid parameter&quot;));</span>
        }
        try {
<span class="nc" id="L561">            return executeCommand(ip, port, FETCH_CLUSTER_MODE_PATH, false)</span>
<span class="nc" id="L562">                .thenApply(r -&gt; JSON.parseObject(r, ClusterStateSimpleEntity.class));</span>
<span class="nc" id="L563">        } catch (Exception ex) {</span>
<span class="nc" id="L564">            logger.warn(&quot;Error when fetching cluster mode&quot;, ex);</span>
<span class="nc" id="L565">            return AsyncUtils.newFailedFuture(ex);</span>
        }
    }

    public CompletableFuture&lt;Void&gt; modifyClusterMode(String ip, int port, int mode) {
<span class="nc bnc" id="L570" title="All 4 branches missed.">        if (StringUtil.isBlank(ip) || port &lt;= 0) {</span>
<span class="nc" id="L571">            return AsyncUtils.newFailedFuture(new IllegalArgumentException(&quot;Invalid parameter&quot;));</span>
        }
        try {
<span class="nc" id="L574">            Map&lt;String, String&gt; params = new HashMap&lt;&gt;(1);</span>
<span class="nc" id="L575">            params.put(&quot;mode&quot;, String.valueOf(mode));</span>
<span class="nc" id="L576">            return executeCommand(ip, port, MODIFY_CLUSTER_MODE_PATH, params, false)</span>
<span class="nc" id="L577">                .thenCompose(e -&gt; {</span>
<span class="nc bnc" id="L578" title="All 2 branches missed.">                    if (CommandConstants.MSG_SUCCESS.equals(e)) {</span>
<span class="nc" id="L579">                        return CompletableFuture.completedFuture(null);</span>
                    } else {
<span class="nc" id="L581">                        logger.warn(&quot;Error when modifying cluster mode: &quot; + e);</span>
<span class="nc" id="L582">                        return AsyncUtils.newFailedFuture(new RuntimeException(e));</span>
                    }
                });
<span class="nc" id="L585">        } catch (Exception ex) {</span>
<span class="nc" id="L586">            logger.warn(&quot;Error when modifying cluster mode&quot;, ex);</span>
<span class="nc" id="L587">            return AsyncUtils.newFailedFuture(ex);</span>
        }
    }

    public CompletableFuture&lt;ClusterClientInfoVO&gt; fetchClusterClientInfoAndConfig(String ip, int port) {
<span class="nc bnc" id="L592" title="All 4 branches missed.">        if (StringUtil.isBlank(ip) || port &lt;= 0) {</span>
<span class="nc" id="L593">            return AsyncUtils.newFailedFuture(new IllegalArgumentException(&quot;Invalid parameter&quot;));</span>
        }
        try {
<span class="nc" id="L596">            return executeCommand(ip, port, FETCH_CLUSTER_CLIENT_CONFIG_PATH, false)</span>
<span class="nc" id="L597">                .thenApply(r -&gt; JSON.parseObject(r, ClusterClientInfoVO.class));</span>
<span class="nc" id="L598">        } catch (Exception ex) {</span>
<span class="nc" id="L599">            logger.warn(&quot;Error when fetching cluster client config&quot;, ex);</span>
<span class="nc" id="L600">            return AsyncUtils.newFailedFuture(ex);</span>
        }
    }

    public CompletableFuture&lt;Void&gt; modifyClusterClientConfig(String app, String ip, int port, ClusterClientConfig config) {
<span class="nc bnc" id="L605" title="All 4 branches missed.">        if (StringUtil.isBlank(ip) || port &lt;= 0) {</span>
<span class="nc" id="L606">            return AsyncUtils.newFailedFuture(new IllegalArgumentException(&quot;Invalid parameter&quot;));</span>
        }
        try {
<span class="nc" id="L609">            Map&lt;String, String&gt; params = new HashMap&lt;&gt;(1);</span>
<span class="nc" id="L610">            params.put(&quot;data&quot;, JSON.toJSONString(config));</span>
<span class="nc" id="L611">            return executeCommand(app, ip, port, MODIFY_CLUSTER_CLIENT_CONFIG_PATH, params, true)</span>
<span class="nc" id="L612">                .thenCompose(e -&gt; {</span>
<span class="nc bnc" id="L613" title="All 2 branches missed.">                    if (CommandConstants.MSG_SUCCESS.equals(e)) {</span>
<span class="nc" id="L614">                        return CompletableFuture.completedFuture(null);</span>
                    } else {
<span class="nc" id="L616">                        logger.warn(&quot;Error when modifying cluster client config: &quot; + e);</span>
<span class="nc" id="L617">                        return AsyncUtils.newFailedFuture(new RuntimeException(e));</span>
                    }
                });
<span class="nc" id="L620">        } catch (Exception ex) {</span>
<span class="nc" id="L621">            logger.warn(&quot;Error when modifying cluster client config&quot;, ex);</span>
<span class="nc" id="L622">            return AsyncUtils.newFailedFuture(ex);</span>
        }
    }

    public CompletableFuture&lt;Void&gt; modifyClusterServerFlowConfig(String app, String ip, int port, ServerFlowConfig config) {
<span class="nc bnc" id="L627" title="All 4 branches missed.">        if (StringUtil.isBlank(ip) || port &lt;= 0) {</span>
<span class="nc" id="L628">            return AsyncUtils.newFailedFuture(new IllegalArgumentException(&quot;Invalid parameter&quot;));</span>
        }
        try {
<span class="nc" id="L631">            Map&lt;String, String&gt; params = new HashMap&lt;&gt;(1);</span>
<span class="nc" id="L632">            params.put(&quot;data&quot;, JSON.toJSONString(config));</span>
<span class="nc" id="L633">            return executeCommand(app, ip, port, MODIFY_CLUSTER_SERVER_FLOW_CONFIG_PATH, params, true)</span>
<span class="nc" id="L634">                .thenCompose(e -&gt; {</span>
<span class="nc bnc" id="L635" title="All 2 branches missed.">                    if (CommandConstants.MSG_SUCCESS.equals(e)) {</span>
<span class="nc" id="L636">                        return CompletableFuture.completedFuture(null);</span>
                    } else {
<span class="nc" id="L638">                        logger.warn(&quot;Error when modifying cluster server flow config: &quot; + e);</span>
<span class="nc" id="L639">                        return AsyncUtils.newFailedFuture(new RuntimeException(e));</span>
                    }
                });
<span class="nc" id="L642">        } catch (Exception ex) {</span>
<span class="nc" id="L643">            logger.warn(&quot;Error when modifying cluster server flow config&quot;, ex);</span>
<span class="nc" id="L644">            return AsyncUtils.newFailedFuture(ex);</span>
        }
    }

    public CompletableFuture&lt;Void&gt; modifyClusterServerTransportConfig(String app, String ip, int port, ServerTransportConfig config) {
<span class="nc bnc" id="L649" title="All 4 branches missed.">        if (StringUtil.isBlank(ip) || port &lt;= 0) {</span>
<span class="nc" id="L650">            return AsyncUtils.newFailedFuture(new IllegalArgumentException(&quot;Invalid parameter&quot;));</span>
        }
        try {
<span class="nc" id="L653">            Map&lt;String, String&gt; params = new HashMap&lt;&gt;(2);</span>
<span class="nc" id="L654">            params.put(&quot;port&quot;, config.getPort().toString());</span>
<span class="nc" id="L655">            params.put(&quot;idleSeconds&quot;, config.getIdleSeconds().toString());</span>
<span class="nc" id="L656">            return executeCommand(app, ip, port, MODIFY_CLUSTER_SERVER_TRANSPORT_CONFIG_PATH, params, false)</span>
<span class="nc" id="L657">                .thenCompose(e -&gt; {</span>
<span class="nc bnc" id="L658" title="All 2 branches missed.">                    if (CommandConstants.MSG_SUCCESS.equals(e)) {</span>
<span class="nc" id="L659">                        return CompletableFuture.completedFuture(null);</span>
                    } else {
<span class="nc" id="L661">                        logger.warn(&quot;Error when modifying cluster server transport config: &quot; + e);</span>
<span class="nc" id="L662">                        return AsyncUtils.newFailedFuture(new RuntimeException(e));</span>
                    }
                });
<span class="nc" id="L665">        } catch (Exception ex) {</span>
<span class="nc" id="L666">            logger.warn(&quot;Error when modifying cluster server transport config&quot;, ex);</span>
<span class="nc" id="L667">            return AsyncUtils.newFailedFuture(ex);</span>
        }
    }

    public CompletableFuture&lt;Void&gt; modifyClusterServerNamespaceSet(String app, String ip, int port, Set&lt;String&gt; set) {
<span class="nc bnc" id="L672" title="All 4 branches missed.">        if (StringUtil.isBlank(ip) || port &lt;= 0) {</span>
<span class="nc" id="L673">            return AsyncUtils.newFailedFuture(new IllegalArgumentException(&quot;Invalid parameter&quot;));</span>
        }
        try {
<span class="nc" id="L676">            Map&lt;String, String&gt; params = new HashMap&lt;&gt;(1);</span>
<span class="nc" id="L677">            params.put(&quot;data&quot;, JSON.toJSONString(set));</span>
<span class="nc" id="L678">            return executeCommand(app, ip, port, MODIFY_CLUSTER_SERVER_NAMESPACE_SET_PATH, params, true)</span>
<span class="nc" id="L679">                .thenCompose(e -&gt; {</span>
<span class="nc bnc" id="L680" title="All 2 branches missed.">                    if (CommandConstants.MSG_SUCCESS.equals(e)) {</span>
<span class="nc" id="L681">                        return CompletableFuture.completedFuture(null);</span>
                    } else {
<span class="nc" id="L683">                        logger.warn(&quot;Error when modifying cluster server NamespaceSet&quot;, e);</span>
<span class="nc" id="L684">                        return AsyncUtils.newFailedFuture(new RuntimeException(e));</span>
                    }
                });
<span class="nc" id="L687">        } catch (Exception ex) {</span>
<span class="nc" id="L688">            logger.warn(&quot;Error when modifying cluster server NamespaceSet&quot;, ex);</span>
<span class="nc" id="L689">            return AsyncUtils.newFailedFuture(ex);</span>
        }
    }

    public CompletableFuture&lt;ClusterServerStateVO&gt; fetchClusterServerBasicInfo(String ip, int port) {
<span class="nc bnc" id="L694" title="All 4 branches missed.">        if (StringUtil.isBlank(ip) || port &lt;= 0) {</span>
<span class="nc" id="L695">            return AsyncUtils.newFailedFuture(new IllegalArgumentException(&quot;Invalid parameter&quot;));</span>
        }
        try {
<span class="nc" id="L698">            return executeCommand(ip, port, FETCH_CLUSTER_SERVER_BASIC_INFO_PATH, false)</span>
<span class="nc" id="L699">                .thenApply(r -&gt; JSON.parseObject(r, ClusterServerStateVO.class));</span>
<span class="nc" id="L700">        } catch (Exception ex) {</span>
<span class="nc" id="L701">            logger.warn(&quot;Error when fetching cluster sever all config and basic info&quot;, ex);</span>
<span class="nc" id="L702">            return AsyncUtils.newFailedFuture(ex);</span>
        }
    }

    public CompletableFuture&lt;List&lt;ApiDefinitionEntity&gt;&gt; fetchApis(String app, String ip, int port) {
<span class="nc bnc" id="L707" title="All 4 branches missed.">        if (StringUtil.isBlank(ip) || port &lt;= 0) {</span>
<span class="nc" id="L708">            return AsyncUtils.newFailedFuture(new IllegalArgumentException(&quot;Invalid parameter&quot;));</span>
        }

        try {
<span class="nc" id="L712">            return executeCommand(ip, port, FETCH_GATEWAY_API_PATH, false)</span>
<span class="nc" id="L713">                    .thenApply(r -&gt; {</span>
<span class="nc" id="L714">                        List&lt;ApiDefinitionEntity&gt; entities = JSON.parseArray(r, ApiDefinitionEntity.class);</span>
<span class="nc bnc" id="L715" title="All 2 branches missed.">                        if (entities != null) {</span>
<span class="nc bnc" id="L716" title="All 2 branches missed.">                            for (ApiDefinitionEntity entity : entities) {</span>
<span class="nc" id="L717">                                entity.setApp(app);</span>
<span class="nc" id="L718">                                entity.setIp(ip);</span>
<span class="nc" id="L719">                                entity.setPort(port);</span>
<span class="nc" id="L720">                            }</span>
                        }
<span class="nc" id="L722">                        return entities;</span>
                    });
<span class="nc" id="L724">        } catch (Exception ex) {</span>
<span class="nc" id="L725">            logger.warn(&quot;Error when fetching gateway apis&quot;, ex);</span>
<span class="nc" id="L726">            return AsyncUtils.newFailedFuture(ex);</span>
        }
    }

    public boolean modifyApis(String app, String ip, int port, List&lt;ApiDefinitionEntity&gt; apis) {
<span class="nc bnc" id="L731" title="All 2 branches missed.">        if (apis == null) {</span>
<span class="nc" id="L732">            return true;</span>
        }

        try {
<span class="nc" id="L736">            AssertUtil.notEmpty(app, &quot;Bad app name&quot;);</span>
<span class="nc" id="L737">            AssertUtil.notEmpty(ip, &quot;Bad machine IP&quot;);</span>
<span class="nc bnc" id="L738" title="All 2 branches missed.">            AssertUtil.isTrue(port &gt; 0, &quot;Bad machine port&quot;);</span>
<span class="nc" id="L739">            String data = JSON.toJSONString(</span>
<span class="nc" id="L740">                    apis.stream().map(r -&gt; r.toApiDefinition()).collect(Collectors.toList()));</span>
<span class="nc" id="L741">            Map&lt;String, String&gt; params = new HashMap&lt;&gt;(2);</span>
<span class="nc" id="L742">            params.put(&quot;data&quot;, data);</span>
<span class="nc" id="L743">            String result = executeCommand(app, ip, port, MODIFY_GATEWAY_API_PATH, params, true).get();</span>
<span class="nc" id="L744">            logger.info(&quot;Modify gateway apis: {}&quot;, result);</span>
<span class="nc" id="L745">            return true;</span>
<span class="nc" id="L746">        } catch (Exception e) {</span>
<span class="nc" id="L747">            logger.warn(&quot;Error when modifying gateway apis&quot;, e);</span>
<span class="nc" id="L748">            return false;</span>
        }
    }

    public CompletableFuture&lt;List&lt;GatewayFlowRuleEntity&gt;&gt; fetchGatewayFlowRules(String app, String ip, int port) {
<span class="nc bnc" id="L753" title="All 4 branches missed.">        if (StringUtil.isBlank(ip) || port &lt;= 0) {</span>
<span class="nc" id="L754">            return AsyncUtils.newFailedFuture(new IllegalArgumentException(&quot;Invalid parameter&quot;));</span>
        }

        try {
<span class="nc" id="L758">            return executeCommand(ip, port, FETCH_GATEWAY_FLOW_RULE_PATH, false)</span>
<span class="nc" id="L759">                    .thenApply(r -&gt; {</span>
<span class="nc" id="L760">                        List&lt;GatewayFlowRule&gt; gatewayFlowRules = JSON.parseArray(r, GatewayFlowRule.class);</span>
<span class="nc" id="L761">                        List&lt;GatewayFlowRuleEntity&gt; entities = gatewayFlowRules.stream().map(rule -&gt; GatewayFlowRuleEntity.fromGatewayFlowRule(app, ip, port, rule)).collect(Collectors.toList());</span>
<span class="nc" id="L762">                        return entities;</span>
                    });
<span class="nc" id="L764">        } catch (Exception ex) {</span>
<span class="nc" id="L765">            logger.warn(&quot;Error when fetching gateway flow rules&quot;, ex);</span>
<span class="nc" id="L766">            return AsyncUtils.newFailedFuture(ex);</span>
        }
    }

    public boolean modifyGatewayFlowRules(String app, String ip, int port, List&lt;GatewayFlowRuleEntity&gt; rules) {
<span class="nc bnc" id="L771" title="All 2 branches missed.">        if (rules == null) {</span>
<span class="nc" id="L772">            return true;</span>
        }

        try {
<span class="nc" id="L776">            AssertUtil.notEmpty(app, &quot;Bad app name&quot;);</span>
<span class="nc" id="L777">            AssertUtil.notEmpty(ip, &quot;Bad machine IP&quot;);</span>
<span class="nc bnc" id="L778" title="All 2 branches missed.">            AssertUtil.isTrue(port &gt; 0, &quot;Bad machine port&quot;);</span>
<span class="nc" id="L779">            String data = JSON.toJSONString(</span>
<span class="nc" id="L780">                    rules.stream().map(r -&gt; r.toGatewayFlowRule()).collect(Collectors.toList()));</span>
<span class="nc" id="L781">            Map&lt;String, String&gt; params = new HashMap&lt;&gt;(2);</span>
<span class="nc" id="L782">            params.put(&quot;data&quot;, data);</span>
<span class="nc" id="L783">            String result = executeCommand(app, ip, port, MODIFY_GATEWAY_FLOW_RULE_PATH, params, true).get();</span>
<span class="nc" id="L784">            logger.info(&quot;Modify gateway flow rules: {}&quot;, result);</span>
<span class="nc" id="L785">            return true;</span>
<span class="nc" id="L786">        } catch (Exception e) {</span>
<span class="nc" id="L787">            logger.warn(&quot;Error when modifying gateway apis&quot;, e);</span>
<span class="nc" id="L788">            return false;</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.3.201901230119</span></div></body></html>